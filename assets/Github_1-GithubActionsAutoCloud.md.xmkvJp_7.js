import{_ as a,c as n,o as p,a5 as e}from"./chunks/framework.BlKpNptw.js";const u=JSON.parse('{"title":"Github Actions 自动化部署","description":"Github Actions 自动化部署","frontmatter":{"sticky":999,"description":"Github Actions 自动化部署","tag":["Github"],"top":1,"sidebar":false},"headers":[],"relativePath":"Github/1-GithubActionsAutoCloud.md","filePath":"Github/1-GithubActionsAutoCloud.md","lastUpdated":1755138831000}'),i={name:"Github/1-GithubActionsAutoCloud.md"};function l(t,s,o,c,h,r){return p(),n("div",{"data-pagefind-body":!0,"data-pagefind-meta":"date:1755138831000"},s[0]||(s[0]=[e(`<h1 id="github-actions-自动化部署" tabindex="-1">Github Actions 自动化部署 <a class="header-anchor" href="#github-actions-自动化部署" aria-label="Permalink to &quot;Github Actions 自动化部署&quot;">​</a></h1><div class="warning custom-block"><p class="custom-block-title">注意事项</p><p>当你提交代码的时候, Github 会自动部署代码;</p><p>当然, 如果没有进行充分的测试, 那么就会: 自动一时爽, 提交火葬场</p></div><h1 id="一、前期准备工作" tabindex="-1">一、前期准备工作 <a class="header-anchor" href="#一、前期准备工作" aria-label="Permalink to &quot;一、前期准备工作&quot;">​</a></h1><h2 id="_1-服务器准备" tabindex="-1">1. 服务器准备 <a class="header-anchor" href="#_1-服务器准备" aria-label="Permalink to &quot;1. 服务器准备&quot;">​</a></h2><p>必要条件: 一台云服务器（Ubuntu/CentOS）</p><p>已配置 Nginx 服务器</p><p>开放相应的端口（如 80、443）,我的环境如下：</p><p><strong>服务器：腾讯云轻量应用服务器</strong></p><p><strong>系统：Ubuntu Server 24.04 LTS 64bit</strong></p><p><strong>端口：80</strong></p><p><strong>node 版本:</strong> v20.14.0</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">node</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span></code></pre></div><p><strong>npm 版本:</strong> 10.7.0</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span></code></pre></div><p><strong>pnpm 版本:</strong> 10.14.0</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span></code></pre></div><p><strong>nginx 版本:</strong> nginx version: nginx/1.24.0 (Ubuntu)</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span></code></pre></div><h2 id="_2-密钥配置" tabindex="-1">2. 密钥配置 <a class="header-anchor" href="#_2-密钥配置" aria-label="Permalink to &quot;2. 密钥配置&quot;">​</a></h2><h4 id="生成密钥" tabindex="-1">生成密钥 <a class="header-anchor" href="#生成密钥" aria-label="Permalink to &quot;生成密钥&quot;">​</a></h4><p><strong>在本地生成 SSH 密钥对：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ssh-keygen -t rsa -b 4096 -C &quot;密钥的名字&quot;</span></span></code></pre></div><p>这会在 <code> ~/.ssh/</code> 目录下生成两个文件：</p><ul><li><p><code>id_rsa</code>：私钥文件，要保密，用于 GitHub Actions 的 <code>SERVER_PRIVATE_KEY</code></p></li><li><p><code>id_rsa.pub</code>：公钥文件，可以共享，用于上传到服务器</p></li></ul><p><strong>将公钥添加到服务器：</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>ssh-copy-id -i ~/.ssh/id_rsa.pub root@your_server_ip</span></span></code></pre></div><p>这个命令会将公钥（<code>id_rsa.pub</code>）的内容追加到服务器的 authorized_keys 文件中</p><div class="warning custom-block"><p class="custom-block-title">重要提示</p><p>私钥（id_rsa）必须保密，下载到你的本地</p><p>公钥（id_rsa.pub）用于服务器认证</p><p>GitHub Actions 中的 SERVER_PRIVATE_KEY 需要使用私钥的内容</p></div><p>注意：服务器上的公钥存放位置：</p><p>普通用户：~/.ssh/authorized_keys 或 /home/用户名/.ssh/authorized_keys</p><p>root 用户：/root/.ssh/authorized_keys</p><p>如果对应目录不存在，需要手动创建并设置正确的权限：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>mkdir -p ~/.ssh</span></span>
<span class="line"><span>chmod 700 ~/.ssh</span></span>
<span class="line"><span>touch ~/.ssh/authorized_keys</span></span>
<span class="line"><span>chmod 600 ~/.ssh/authorized_keys</span></span></code></pre></div><p>注意：Ubuntu 系统默认禁止 root 用户通过 SSH 登录，需要修改 SSH 配置文件：</p><h4 id="编辑-ssh-配置文件" tabindex="-1">编辑 SSH 配置文件 <a class="header-anchor" href="#编辑-ssh-配置文件" aria-label="Permalink to &quot;编辑 SSH 配置文件&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo vim /etc/ssh/sshd_config</span></span></code></pre></div><h4 id="修改或添加以下配置" tabindex="-1">修改或添加以下配置 <a class="header-anchor" href="#修改或添加以下配置" aria-label="Permalink to &quot;修改或添加以下配置&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PermitRootLogin yes              # 允许 root 登录</span></span>
<span class="line"><span>PubkeyAuthentication yes         # 启用公钥认证</span></span>
<span class="line"><span>PasswordAuthentication no        # 禁用密码认证</span></span>
<span class="line"><span>PubkeyAcceptedKeyTypes +ssh-rsa  # 支持 ssh-rsa 类型的密钥</span></span></code></pre></div><h4 id="重启-ssh-服务" tabindex="-1">重启 SSH 服务 <a class="header-anchor" href="#重启-ssh-服务" aria-label="Permalink to &quot;重启 SSH 服务&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo systemctl restart sshd</span></span></code></pre></div><h1 id="二、配置-github-actions" tabindex="-1">二、配置 GitHub Actions <a class="header-anchor" href="#二、配置-github-actions" aria-label="Permalink to &quot;二、配置 GitHub Actions&quot;">​</a></h1><h2 id="_1-添加-secrets" tabindex="-1">1. 添加 Secrets <a class="header-anchor" href="#_1-添加-secrets" aria-label="Permalink to &quot;1. 添加 Secrets&quot;">​</a></h2><p>信息 配置步骤进入仓库的 Settings -&gt; Secrets and variables -&gt; Actions 对应的链接为：</p><p><a href="https://github.com/%E4%BD%A0%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E9%A1%B9%E7%9B%AE%E5%90%8D/settings/secrets/actions/new" target="_blank" rel="noreferrer">https://github.com/你的用户名/项目名/settings/secrets/actions/new</a></p><p>添加以下信息：</p><ul><li><p>SERVER_IP: 服务器 IP 地址</p></li><li><p>SERVER_PORT: SSH 端口（默认 22）</p></li><li><p>SERVER_USERNAME: 服务器用户名</p></li><li><p>SERVER_PRIVATE_KEY: SSH 私钥内容 id_rsa 文件全选复制，连---end 都要复制</p></li></ul><h2 id="_2-创建-workflow-文件" tabindex="-1">2. 创建 Workflow 文件 <a class="header-anchor" href="#_2-创建-workflow-文件" aria-label="Permalink to &quot;2. 创建 Workflow 文件&quot;">​</a></h2><p>在项目根目录创建 .github/workflows/deploy-cloud.yml 文件：</p><p>你可以参考我的工作流配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>name: Deploy to Server</span></span>
<span class="line"><span></span></span>
<span class="line"><span>on:</span></span>
<span class="line"><span>  push:</span></span>
<span class="line"><span>    branches:</span></span>
<span class="line"><span>      - main  # 当 main 分支有提交时触发</span></span>
<span class="line"><span></span></span>
<span class="line"><span>jobs:</span></span>
<span class="line"><span>  deploy-server:</span></span>
<span class="line"><span>    runs-on: ubuntu-latest</span></span>
<span class="line"><span>    # 作业中的执行步骤</span></span>
<span class="line"><span>    steps:</span></span>
<span class="line"><span>      # 步骤 1: 检出代码</span></span>
<span class="line"><span>      - uses: actions/checkout@v4 # 使用官方的 checkout Action，从仓库检出代码</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      # 步骤 2: 设置 Node.js 环境</span></span>
<span class="line"><span>      - name: Setup Node.js</span></span>
<span class="line"><span>        uses: actions/setup-node@v4 # 使用官方的 Node.js Action</span></span>
<span class="line"><span>        with:</span></span>
<span class="line"><span>          node-version: &#39;20&#39; # 指定使用的 Node.js 版本为 20</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      # 步骤 3: 安装 pnpm（Node.js 的包管理工具）</span></span>
<span class="line"><span>      - name: Setup pnpm</span></span>
<span class="line"><span>        uses: pnpm/action-setup@v2 # 使用 pnpm 的官方 GitHub Action</span></span>
<span class="line"><span>        with:</span></span>
<span class="line"><span>          version: &#39;9.8.0&#39; # 指定安装的 pnpm 版本为 9.8.0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      # 步骤 4: 安装依赖</span></span>
<span class="line"><span>      - name: Install Dependencies</span></span>
<span class="line"><span>        run: pnpm install # 使用 pnpm 安装项目依赖</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      # 步骤 5: 构建项目</span></span>
<span class="line"><span>      - name: Build</span></span>
<span class="line"><span>        run: pnpm build # 执行项目的构建脚本</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      # 步骤 6: 部署到 服务器</span></span>
<span class="line"><span>      - name: Deploy to Server</span></span>
<span class="line"><span>        uses: appleboy/scp-action@master</span></span>
<span class="line"><span>        with:</span></span>
<span class="line"><span>          host: \${{ secrets.SERVER_HOST }}</span></span>
<span class="line"><span>          username: \${{ secrets.SERVER_USERNAME }}</span></span>
<span class="line"><span>          key: \${{ secrets.SSH_PRIVATE_KEY }}</span></span>
<span class="line"><span>          port: \${{ secrets.SERVER_PORT }}</span></span>
<span class="line"><span>          source: &quot;build/*&quot;</span></span>
<span class="line"><span>          # 推送到这个路径下， 这是我的打包好的项目路径，要更换成你的</span></span>
<span class="line"><span>          target: &quot;/model/blog/build/&quot;  </span></span>
<span class="line"><span>          strip_components: 1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      - name: Cleanup</span></span>
<span class="line"><span>        if: always()</span></span>
<span class="line"><span>        run: |</span></span>
<span class="line"><span>          rm -rf build</span></span>
<span class="line"><span>          rm -rf .docusaurus</span></span></code></pre></div><h1 id="三、服务器配置" tabindex="-1">三、服务器配置 <a class="header-anchor" href="#三、服务器配置" aria-label="Permalink to &quot;三、服务器配置&quot;">​</a></h1><h2 id="_1-nginx-配置" tabindex="-1">1. Nginx 配置 <a class="header-anchor" href="#_1-nginx-配置" aria-label="Permalink to &quot;1. Nginx 配置&quot;">​</a></h2><h3 id="nginx-设置" tabindex="-1">Nginx 设置 <a class="header-anchor" href="#nginx-设置" aria-label="Permalink to &quot;Nginx 设置&quot;">​</a></h3><p>创建或修改 Nginx 配置文件：</p><p>参考我的配置。 博客站点 (通过 IP 80 端口访问)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>server {</span></span>
<span class="line"><span>    listen 80;</span></span>
<span class="line"><span>    server_name bianliangrensheng.cn www.bianliangrensheng.cn;  # 域名访问</span></span>
<span class="line"><span>    root /model/blog/build;</span></span>
<span class="line"><span>    index index.html;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location / {</span></span>
<span class="line"><span>        try_files $uri $uri/ /index.html;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # 静态资源缓存配置</span></span>
<span class="line"><span>    location /assets/ {</span></span>
<span class="line"><span>        expires 30d;</span></span>
<span class="line"><span>        add_header Cache-Control &quot;public, no-transform&quot;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    location /img/ {</span></span>
<span class="line"><span>        expires 30d;</span></span>
<span class="line"><span>        add_header Cache-Control &quot;public, no-transform&quot;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="_2-权限设置" tabindex="-1">2. 权限设置 <a class="header-anchor" href="#_2-权限设置" aria-label="Permalink to &quot;2. 权限设置&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">注意事项</p><p>果不是 root 登录的话，可能会有权限问题，请你调整权限， 确保部署目录具有正确的权限。</p></div><h1 id="四、自动化部署流程" tabindex="-1">四、自动化部署流程 <a class="header-anchor" href="#四、自动化部署流程" aria-label="Permalink to &quot;四、自动化部署流程&quot;">​</a></h1><h4 id="部署过程" tabindex="-1">部署过程 <a class="header-anchor" href="#部署过程" aria-label="Permalink to &quot;部署过程&quot;">​</a></h4><ul><li><p>推送代码到 GitHub <code>main</code> 分支</p></li><li><p>GitHub Actions 自动触发构建流程</p></li><li><p>构建完成后，通过 <code>SSH</code> 将文件传输到云服务器</p></li><li><p>Nginx 自动加载新的静态文件</p></li></ul><h1 id="五、常见问题及解决方案" tabindex="-1">五、常见问题及解决方案 <a class="header-anchor" href="#五、常见问题及解决方案" aria-label="Permalink to &quot;五、常见问题及解决方案&quot;">​</a></h1><h4 id="故障排除-部署失败" tabindex="-1">故障排除 部署失败 <a class="header-anchor" href="#故障排除-部署失败" aria-label="Permalink to &quot;故障排除 部署失败&quot;">​</a></h4><ul><li><p>检查 Secrets 配置是否正确</p></li><li><p>确认服务器防火墙设置</p></li><li><p>查看 GitHub Actions 日志</p></li><li><p>网站无法访问</p></li><li><p>检查 Nginx 配置</p></li><li><p>确认端口是否开放</p></li><li><p>验证文件权限设置</p></li><li><p>文件传输问题</p></li><li><p>确认 SSH 密钥配置正常</p></li><li><p>检查目录权限</p></li><li><p>验证磁盘空间</p></li></ul><h1 id="六、总结" tabindex="-1">六、总结 <a class="header-anchor" href="#六、总结" aria-label="Permalink to &quot;六、总结&quot;">​</a></h1><p>通过 GitHub Actions 实现自动化部署到云服务器，不仅提高了开发效率，也保证了部署的一致性和可靠性。 这个过程虽然初期配置较为复杂，但一旦设置完成，后续的维护和使用都会变得非常简单，并且我也不是一次成功，失败了 n 多次</p><p>现在当我推送代码到 github 上以后，会触发部署工作流，重新部署服务器上项目</p>`,67)]))}const b=a(i,[["render",l]]);export{u as __pageData,b as default};
